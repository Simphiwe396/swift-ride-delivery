<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard - SwiftRide</title>
    
    <!-- PWA Configuration -->
    <meta name="application-name" content="SwiftRide">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#6C63FF">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="./icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icons/favicon-16x16.png">
    <link rel="manifest" href="./site.webmanifest">
    <link rel="icon" type="image/x-icon" href="./icons/favicon.ico">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="./styles.css">
    
    <style>
        .driver-dashboard {
            min-height: 100vh;
            background: #F8F9FF;
        }
        
        .driver-header {
            background: linear-gradient(135deg, #6C63FF, #4A43C8);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .driver-avatar-lg {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .driver-status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .status-online { background: #4CAF50; }
        .status-offline { background: #9E9E9E; }
        .status-busy { background: #FF9800; }
        
        .driver-content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #6C63FF;
            margin: 10px 0;
        }
        
        .map-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        #driverMap {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .map-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #6C63FF;
            color: white;
        }
        
        .btn-secondary {
            background: #E8EAF2;
            color: #333;
        }
        
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        
        .deliveries-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .delivery-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #E8EAF2;
        }
        
        .delivery-item:last-child {
            border-bottom: none;
        }
        
        .delivery-info h4 {
            margin: 0 0 5px 0;
        }
        
        .delivery-info p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }
        
        .delivery-actions {
            display: flex;
            gap: 10px;
        }
        
        .status-controls {
            display: flex;
            gap: 10px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .navigation-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        .nav-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            color: #6C63FF;
        }
        
        .nav-btn:hover {
            background: #6C63FF;
            color: white;
            transform: scale(1.1);
        }
    </style>
</head>
<body data-page="driver">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loader"></div>
        <h2>SwiftRide Driver</h2>
        <p>Loading your dashboard...</p>
    </div>
    
    <!-- Driver Dashboard -->
    <div class="driver-dashboard">
        <!-- Header -->
        <header class="driver-header">
            <div class="driver-info">
                <div class="driver-avatar-lg" id="driverAvatar">D</div>
                <div>
                    <h2 id="driverName">Driver Name</h2>
                    <div class="driver-status-badge status-offline" id="driverStatusBadge">
                        Offline
                    </div>
                </div>
            </div>
            
            <div class="status-controls">
                <button class="btn btn-success" id="goOnlineBtn">
                    <i class="fas fa-power-off"></i> Go Online
                </button>
                <button class="btn btn-secondary" id="goOfflineBtn">
                    <i class="fas fa-power-off"></i> Go Offline
                </button>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="driver-content">
            <!-- Stats Row -->
            <div class="stats-row">
                <div class="stat-box">
                    <i class="fas fa-money-bill-wave"></i>
                    <div class="stat-value" id="todayEarnings">R 0.00</div>
                    <p>Today's Earnings</p>
                </div>
                <div class="stat-box">
                    <i class="fas fa-box"></i>
                    <div class="stat-value" id="completedTrips">0</div>
                    <p>Completed Trips</p>
                </div>
                <div class="stat-box">
                    <i class="fas fa-clock"></i>
                    <div class="stat-value" id="avgRating">5.0</div>
                    <p>Your Rating</p>
                </div>
                <div class="stat-box">
                    <i class="fas fa-road"></i>
                    <div class="stat-value" id="totalDistance">0 km</div>
                    <p>Distance Today</p>
                </div>
            </div>
            
            <!-- Map Section -->
            <div class="map-section">
                <h2>Your Location</h2>
                <div id="driverMap"></div>
                <div class="map-buttons">
                    <button class="btn btn-primary" id="centerOnMeBtn">
                        <i class="fas fa-location-arrow"></i> Center on Me
                    </button>
                    <button class="btn btn-secondary" id="findDeliveriesBtn">
                        <i class="fas fa-search"></i> Find Deliveries
                    </button>
                </div>
            </div>
            
            <!-- Deliveries Section -->
            <div class="deliveries-section">
                <h2>Available Deliveries</h2>
                <div id="driverDeliveriesList">
                    <!-- Deliveries will be loaded here -->
                    <div class="empty-state">
                        <i class="fas fa-box"></i>
                        <p>No deliveries available</p>
                        <small>Go online to receive deliveries</small>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Navigation Buttons -->
    <div class="navigation-buttons">
        <button class="nav-btn" onclick="window.location.href='tracking.html'" title="Track">
            <i class="fas fa-map-marker-alt"></i>
        </button>
        <button class="nav-btn" onclick="window.location.href='index.html'" title="Home">
            <i class="fas fa-home"></i>
        </button>
        <button class="nav-btn" onclick="logout()" title="Logout">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </div>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="./app.js"></script>
    
    <!-- Driver Page Script -->
    <script>
        let driverMap = null;
        let driverMarker = null;
        
        // Wait for app.js to load
        setTimeout(() => {
            initDriverPage();
        }, 500);
        
        function initDriverPage() {
            console.log('Driver page initializing');
            
            // Check if driver is logged in
            if (!AppState.user || AppState.user.userType !== 'driver') {
                showNotification('Please login as driver first', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }
            
            // Update driver info
            if (AppState.user) {
                document.getElementById('driverName').textContent = AppState.user.name;
                document.getElementById('driverAvatar').textContent = AppState.user.name.charAt(0);
            }
            
            // Initialize map
            initDriverMap();
            
            // Load driver data
            loadDriverData();
            
            // Setup event listeners
            setupDriverListeners();
        }
        
        function initDriverMap() {
            setTimeout(() => {
                try {
                    const mapContainer = document.getElementById('driverMap');
                    if (!mapContainer) return;
                    
                    // Clear container
                    mapContainer.innerHTML = '';
                    mapContainer.style.height = '400px';
                    mapContainer.style.width = '100%';
                    
                    // Create map centered on Johannesburg
                    driverMap = L.map('driverMap').setView([-26.195246, 28.034088], 14);
                    
                    // Add tiles
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap'
                    }).addTo(driverMap);
                    
                    // Add driver marker
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(position => {
                            const { latitude, longitude } = position.coords;
                            
                            driverMarker = L.marker([latitude, longitude]).addTo(driverMap);
                            driverMarker.bindPopup(`
                                <strong>Your Location</strong><br>
                                ${AppState.user?.name || 'Driver'}
                            `);
                            
                            // Center map on driver
                            driverMap.setView([latitude, longitude], 14);
                        });
                    } else {
                        // Default marker
                        driverMarker = L.marker([-26.195246, 28.034088]).addTo(driverMap);
                        driverMarker.bindPopup('<strong>Default Location</strong>');
                    }
                    
                    console.log('Driver map initialized');
                    
                } catch (error) {
                    console.error('Failed to initialize driver map:', error);
                    
                    // Fallback if map fails
                    const mapContainer = document.getElementById('driverMap');
                    mapContainer.innerHTML = `
                        <div style="height:400px;background:linear-gradient(135deg,#6C63FF,#4A43C8);border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;text-align:center;">
                            <div>
                                <i class="fas fa-map-marked-alt" style="font-size:3rem;"></i>
                                <h3>Map View</h3>
                                <p>Your location will be shown here</p>
                            </div>
                        </div>
                    `;
                }
            }, 1000);
        }
        
        async function loadDriverData() {
            try {
                // Update stats with sample data
                document.getElementById('todayEarnings').textContent = 'R 450.00';
                document.getElementById('completedTrips').textContent = '8';
                document.getElementById('avgRating').textContent = '4.9';
                document.getElementById('totalDistance').textContent = '42 km';
                
                // Load sample deliveries
                const deliveries = [
                    { 
                        id: '1', 
                        from: 'Rosebank Mall', 
                        to: 'Sandton City', 
                        price: 'R 75.00',
                        distance: '8 km'
                    },
                    { 
                        id: '2', 
                        from: 'Melville', 
                        to: 'Randburg', 
                        price: 'R 45.00',
                        distance: '5 km'
                    },
                    { 
                        id: '3', 
                        from: 'Johannesburg CBD', 
                        to: 'Midrand', 
                        price: 'R 120.00',
                        distance: '15 km'
                    }
                ];
                
                renderDeliveriesList(deliveries);
                
            } catch (error) {
                console.error('Failed to load driver data:', error);
            }
        }
        
        function renderDeliveriesList(deliveries) {
            const container = document.getElementById('driverDeliveriesList');
            if (!container) return;
            
            if (!deliveries || deliveries.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box"></i>
                        <p>No deliveries available</p>
                        <small>Go online to receive deliveries</small>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = deliveries.map(delivery => `
                <div class="delivery-item">
                    <div class="delivery-info">
                        <h4>${delivery.from} → ${delivery.to}</h4>
                        <p>${delivery.distance} • ${delivery.price}</p>
                    </div>
                    <div class="delivery-actions">
                        <button class="btn btn-primary" onclick="acceptDelivery('${delivery.id}')">
                            <i class="fas fa-check"></i> Accept
                        </button>
                        <button class="btn btn-secondary" onclick="viewDelivery('${delivery.id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function setupDriverListeners() {
            // Online button
            const onlineBtn = document.getElementById('goOnlineBtn');
            if (onlineBtn) {
                onlineBtn.addEventListener('click', () => {
                    document.getElementById('driverStatusBadge').className = 'driver-status-badge status-online';
                    document.getElementById('driverStatusBadge').textContent = 'Online';
                    showNotification('You are now online', 'success');
                    
                    // Update status
                    if (driverMarker) {
                        driverMarker.setIcon(
                            L.divIcon({
                                className: 'driver-marker',
                                html: '<div style="background:#4CAF50;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 0 10px rgba(0,0,0,0.3);"></div>'
                            })
                        );
                    }
                });
            }
            
            // Offline button
            const offlineBtn = document.getElementById('goOfflineBtn');
            if (offlineBtn) {
                offlineBtn.addEventListener('click', () => {
                    document.getElementById('driverStatusBadge').className = 'driver-status-badge status-offline';
                    document.getElementById('driverStatusBadge').textContent = 'Offline';
                    showNotification('You are now offline', 'info');
                    
                    // Update status
                    if (driverMarker) {
                        driverMarker.setIcon(
                            L.divIcon({
                                className: 'driver-marker',
                                html: '<div style="background:#9E9E9E;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 0 10px rgba(0,0,0,0.3);"></div>'
                            })
                        );
                    }
                });
            }
            
            // Center on me button
            const centerBtn = document.getElementById('centerOnMeBtn');
            if (centerBtn) {
                centerBtn.addEventListener('click', () => {
                    if (navigator.geolocation && driverMap) {
                        navigator.geolocation.getCurrentPosition(position => {
                            const { latitude, longitude } = position.coords;
                            driverMap.setView([latitude, longitude], 14);
                            showNotification('Map centered on your location', 'success');
                        });
                    }
                });
            }
            
            // Find deliveries button
            const findBtn = document.getElementById('findDeliveriesBtn');
            if (findBtn) {
                findBtn.addEventListener('click', () => {
                    showNotification('Searching for deliveries...', 'info');
                    loadDriverData(); // Reload data
                });
            }
        }
        
        function acceptDelivery(deliveryId) {
            showNotification(`Delivery ${deliveryId} accepted!`, 'success');
        }
        
        function viewDelivery(deliveryId) {
            showNotification(`Viewing delivery ${deliveryId}`, 'info');
        }
    </script>
</body>
</html>